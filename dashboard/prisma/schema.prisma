generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String        @id @default(uuid())
  email            String        @unique
  passwordHash     String
  name             String?
  subscriptionTier String        @default("free")
  stripeCustomerId String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  devices          Device[]
  pairingCodes     PairingCode[]
  saves            Save[]
}

model Device {
  id            String         @id @default(uuid())
  userId        String
  name          String
  deviceType    String
  apiKey        String         @unique
  lastSyncAt    DateTime?
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  pairingCode   PairingCode?
  saveLocations SaveLocation[]
  saveVersions  SaveVersion[]
  syncLogs      SyncLog[]

  @@index([userId])
  @@index([apiKey])
}

model PairingCode {
  id               String    @id @default(uuid())
  code             String    @unique
  userId           String?
  deviceId         String?   @unique
  /// 6-digit temporary identifier used by the device during auto-pairing
  deviceIdentifier String?
  expiresAt        DateTime
  used             Boolean   @default(false)
  usedAt           DateTime?
  deviceType       String?
  createdAt        DateTime  @default(now())
  device           Device?   @relation(fields: [deviceId], references: [id])
  user             User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([userId])
  @@index([deviceId])
  @@index([deviceIdentifier])
}

model SyncLog {
  id            String       @id @default(uuid())
  deviceId      String
  action        String
  filePath      String
  fileSize      Int?
  status        String
  errorMsg      String?
  metadata      String?
  createdAt     DateTime     @default(now())
  saveId        String?
  saveVersionId String?
  device        Device       @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  save          Save?        @relation(fields: [saveId], references: [id])
  saveVersion   SaveVersion? @relation(fields: [saveVersionId], references: [id])

  @@index([deviceId])
  @@index([createdAt])
  @@index([saveId])
  @@index([saveVersionId])
}

model Save {
  id           String         @id @default(uuid())
  userId       String
  saveKey      String
  displayName  String
  /// "shared" = one version syncs to all devices (latest wins); "per_device" = each device has its own, all backed up
  syncStrategy String   @default("shared")
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  locations    SaveLocation[]
  versions     SaveVersion[]
  syncLogs     SyncLog[]

  @@unique([userId, saveKey])
  @@index([userId])
}

model SaveVersion {
  id              String    @id @default(uuid())
  saveId          String
  deviceId        String
  contentHash     String
  byteSize        Int
  localModifiedAt DateTime
  uploadedAt      DateTime  @default(now())
  storageKey      String
  device          Device    @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  save            Save      @relation(fields: [saveId], references: [id], onDelete: Cascade)
  syncLogs        SyncLog[]

  @@index([saveId])
  @@index([deviceId])
  @@index([uploadedAt])
  @@index([localModifiedAt])
  @@index([contentHash])
}

model SaveLocation {
  id          String   @id @default(uuid())
  saveId      String
  deviceId    String
  deviceType  String
  localPath   String
  /// sync | upload_only | disabled
  syncMode    String   @default("sync")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  device      Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  save        Save     @relation(fields: [saveId], references: [id], onDelete: Cascade)

  @@unique([saveId, deviceId, localPath])
  @@index([deviceId])
  @@index([saveId])
}
